<% layout("/layouts/boilerplate")%>
<script>
  const mapToken = "<%=process.env.MAP_TOKEN%>";
  const coordinates = <%-JSON.stringify(listing.geometry.coordinates)%>;
  const listing = <%-JSON.stringify(listing)%>;
</script>
<div class="row mt-3">
  <div class="col-12 col-lg-8 offset-lg-2">
    <div
      class="d-flex align-items-center justify-content-between flex-wrap gap-2"
    >
      <div>
        <h3 class="mb-1"><%= listing.title %></h3>
      </div>
      <div class="text-end">
        <div class="h5 mb-0">
          &#8377; <%= listing.price.toLocaleString('en-IN') %>
          <small class="text-muted">per night</small>
        </div>
      </div>
    </div>
  </div>

  <div class="card col-12 col-lg-8 offset-lg-2 show-card listing-card">
    <div class="media-wrap">
      <div class="img-frame">
        <% const catKey = (category && category.key) || 'trending'; const
        iconMap = { rooms: 'fa-solid fa-bed', mountains: 'fa-solid fa-mountain',
        pools: 'fa-solid fa-person-swimming', camping: 'fa-solid fa-campground',
        arctic: 'fa-regular fa-snowflake', skiing: 'fa-solid fa-person-skiing',
        campervan: 'fa-solid fa-caravan', hills: 'fa-solid fa-mountain-city',
        castles: 'fa-brands fa-fort-awesome-alt', luxe: 'fa-solid fa-star',
        cruise: 'fa-solid fa-ferry', trending: 'fa-solid fa-fire' }; const
        iconClass = iconMap[catKey] || 'fa-solid fa-fire'; %>
        <div class="card-badges">
          <span class="chip chip-accent"><i class="<%= iconClass %>"></i><%= (category && category.label) || 'Trending' %></span>
          <% (listing.tags || []).forEach(t => { %>
            <span class="chip"><%= t %></span>
          <% }) %>
        </div>
        <img
          src="<%=listing.image.url%>"
          class="card-img-top show-img"
          alt="listing_image"
        />
      </div>
    </div>
    <div class="card-body">
      <div class="mb-2 text-muted">
        Owner:
        <i
          ><%= (listing.owner && listing.owner.username) ?
          listing.owner.username : 'Unknown' %></i
        >
        &nbsp;â€¢&nbsp; <%= listing.location %> , <%= listing.country %>
      </div>

      <p class="card-text"><%= listing.description %></p>

      <div class="row g-2 align-items-end mt-3">
        <div class="col-6">
          <label class="form-label" for="checkIn">Check-in</label>
          <input type="date" class="form-control" id="checkIn" />
        </div>
        <div class="col-6">
          <label class="form-label" for="checkOut">Check-out</label>
          <input type="date" class="form-control" id="checkOut" />
        </div>
      </div>
      <div id="bookingSummary" class="mt-3" aria-live="polite"></div>
    </div>
  </div>

  <div class="col-12 col-lg-8 offset-lg-2 mt-3">
    <h4 class="mb-2">Amenities</h4>
    <div class="amenities">
      <% (amenities || []).forEach(a => { %>
      <div class="amenity">
        <i class="fa <%= a.icon %>"></i> <span><%= a.label %></span>
      </div>
      <% }) %>
    </div>
  </div>
  <%if(currUser&&listing.owner._id.equals(currUser._id)){%>
  <div class="col-12 col-lg-8 offset-lg-2">
    <div class="btns mb-3 mt-3">
      <a
        href="/listings/<%= listing._id %>/edit"
        class="btn btn-dark me-2 edit-btn"
        >Edit</a
      >

      <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE">
        <button class="btn btn-dark">Delete</button>
      </form>
    </div>
    <hr />
  </div>
  <% } %>
  <div class="col-12 col-lg-8 offset-lg-2 mb-3">
    <%if(currUser){%>
    <hr />
    <h4>Leave a Review</h4>

    <form
      action="/listings/<%= listing.id%>/reviews"
      method="POST"
      novalidate
      class="needs-validation"
    >
      <div class="mb-3 mt-3">
        <label for="rating" class="form-label">Rating</label>
        <fieldset class="starability-slot">
          <input
            type="radio"
            id="no-rate"
            class="input-no-rate"
            name="review[rating]"
            value="1"
            checked
            aria-label="No rating."
          />
          <input
            type="radio"
            id="first-rate1"
            name="review[rating]"
            value="1"
          />
          <label for="first-rate1" title="Terrible">1 star</label>
          <input
            type="radio"
            id="first-rate2"
            name="review[rating]"
            value="2"
          />
          <label for="first-rate2" title="Not good">2 stars</label>
          <input
            type="radio"
            id="first-rate3"
            name="review[rating]"
            value="3"
          />
          <label for="first-rate3" title="Average">3 stars</label>
          <input
            type="radio"
            id="first-rate4"
            name="review[rating]"
            value="4"
          />
          <label for="first-rate4" title="Very good">4 stars</label>
          <input
            type="radio"
            id="first-rate5"
            name="review[rating]"
            value="5"
          />
          <label for="first-rate5" title="Amazing">5 stars</label>
        </fieldset>
      </div>

      <div class="mb-3 mt-3">
        <label for="comment" class="form-label">Comments</label>
        <textarea
          name="review[comment]"
          id="comment"
          cols="30"
          rows="5"
          class="form-control"
          required
        ></textarea>
        <div class="invalid-feedback">Please add some comments for review</div>
      </div>
      <button class="btn btn-outline-dark">Submit</button>
    </form>
    <%}%>
    <hr />
    <% if (listing.reviews.length > 0) { %>
    <h4 class="mt-4 mb-3">All Reviews</h4>
    <div class="row g-4">
      <% for (review of listing.reviews) { %>
      <div class="col-12 col-md-6">
        <div class="card h-100">
          <div class="card-body d-flex flex-column p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0"><%= review.author.username %></h6>
              <span
                class="starability-result"
                data-rating="<%=review.rating%>"
              ></span>
            </div>
            <p class="card-text mb-4"><%= review.comment %></p>
            <div class="mt-auto d-flex justify-content-end">
              <form
                method="POST"
                action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE"
              >
                <button class="btn btn-sm btn-outline-dark">Delete</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </div>
    <% } %>
  </div>

  <div class="col-12 col-lg-8 offset-lg-2 mb-4">
    <h4 class="mb-2">Where you'll be</h4>
    <div id="map"></div>
  </div>

  <% if (similarListings && similarListings.length) { %>
  <div class="col-12 col-lg-8 offset-lg-2 mb-5">
    <h4 class="mb-3">Similar Properties</h4>
    <div class="row row-cols-1 row-cols-sm-2 g-3">
      <% for (const s of similarListings) { %>
      <div class="col">
        <a class="listing_links" href="/listings/<%= s._id %>">
          <div class="card h-100 listing-card">
            <img
              src="<%= s.image.url %>"
              class="card-img-top listing-img"
              alt="<%= s.title %>"
            />
            <div class="card-body">
              <p class="mb-1"><b><%= s.title %></b></p>
              <span>&#8377; <%= s.price.toLocaleString('en-IN') %></span>
              <span class="text-muted">/ night</span>
            </div>
          </div>
        </a>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>
</div>
<script src="/js/map.js"></script>
<script src="/js/booking.js"></script>
