<% layout("/layouts/boilerplate")%>

<div class="container mt-5">
  <h2 class="mb-4">ðŸ§³ Plan Your Trip</h2>

  <form id="itineraryForm" action="/listings/itinerary" method="POST" class="row g-3">
    <div class="col-12 col-md-8">
      <label for="place" class="form-label">Destination</label>
      <input type="text" class="form-control" id="place" name="place" required />
    </div>
    <div class="col-6 col-md-4">
      <label for="days" class="form-label">Number of Days</label>
      <input type="number" class="form-control" id="days" name="days" required />
    </div>
    <div class="col-12 d-flex align-items-center gap-3">
      <button id="genBtn" type="submit" class="btn btn-danger">Generate Itinerary</button>
      <div id="loading" class="d-none">
        <span class="spinner-border spinner-border-sm text-danger" role="status" aria-hidden="true"></span>
        <span class="ms-2 text-muted">Generating itinerary...</span>
      </div>
    </div>
    <p id="wait-message" class="text-muted small">
      Please hold on for a moment after clicking <strong>"Generate Itinerary"</strong> â€” we're crafting your personalized travel plan.
    </p>
    <hr />
  </form>

  <% if (itinerary) { %>
  <div class="mt-4 p-3 bg-light rounded shadow" id="itineraryCard">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Your Itinerary</h4>
      <button id="downloadPdf" type="button" class="btn btn-outline-danger btn-sm">Download PDF</button>
    </div>
    <div class="itinerary-content mt-3" id="itineraryContent"><%- itinerary %></div>
  </div>
  <% } %>
</div>

<style>
  .itinerary-content img { max-width: 100%; height: auto; }
  .itinerary-content pre, .itinerary-content code { white-space: pre-wrap; word-wrap: break-word; }
</style>

<!-- Lightweight client-side PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  (function(){
    const form = document.getElementById('itineraryForm');
    const btn = document.getElementById('genBtn');
    const loading = document.getElementById('loading');
    const msg = document.getElementById('wait-message');
    if(form){
      form.addEventListener('submit', function(){
        btn.setAttribute('disabled', 'disabled');
        loading.classList.remove('d-none');
        if(msg) msg.classList.add('d-none');
      });
    }

    // PDF download handler
    const dlBtn = document.getElementById('downloadPdf');
    const content = document.getElementById('itineraryContent');
    if (dlBtn && content && typeof html2pdf !== 'undefined') {
      dlBtn.addEventListener('click', function(){
        const place = (document.getElementById('place') && document.getElementById('place').value) || 'itinerary';
        const days = (document.getElementById('days') && document.getElementById('days').value) || '';
        const filename = `${place}-${days ? days + 'd-' : ''}itinerary`.replace(/\s+/g,'_') + '.pdf';
        const opt = {
          margin: [10,10,10,10],
          filename,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        };
        html2pdf().set(opt).from(content).save();
      });
    }
  })();
</script>
